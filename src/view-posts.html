<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="my-icons.html">

<dom-module id="view-posts">
  <template>
    <style>
      :host {
        display: block;
        margin-bottom: 40px;
      }

      #list {
        max-width: 100%;
      }

      h1 {
        color: white;
        letter-spacing: 2px;
        font-weight: 500;
      }

      .item {
        @apply(--layout-horizontal);
        margin: 8px 0;
        background: rgba(255, 255, 255, 0.5);
        padding: 16px;
      }

      .avatar {
        height: 60px;
        width: 60px;
        border-radius: 50%;
        box-sizing: border-box;
        vertical-align: middle;
        margin-right: 16px;
      }

      .name {
        font-size: 12px;
        font-weight: 100;
        margin-bottom: 10px;
      }

      .giant {
        font-size: 36px;
        font-weight: 100;
        padding-right: 30px;
      }

      .small {
        padding-top: 10px;
        font-size: 10px;
      }

      .heart-icon {
        position: absolute;
        top: 16px;
        right: 16px;
        color: var(--app-error-color);
      }

      .horizontal {
        @apply(--layout-horizontal);
      }

      .vertical {
        @apply(--layout-vertical);
      }

      iron-icon.location {
        height: 16px;
        vertical-align: middle;
      }

      button {
        background: transparent;
        border: none;
        outline: none;
        cursor: pointer;
      }

      button:hover {
        color: var(--app-error-color);
      }
    </style>

    <firebase-query
      data="{{_fbPosts}}"
      path="/posts/{{ref}}"
      order-by-child="index">
    </firebase-query>
    <app-indexeddb-mirror
      session="[[uid]]"
      key="/posts/{{ref}}"
      data="[[_fbPosts]]"
      persisted-data="{{posts}}"
      online="[[!offline]]">
    </app-indexeddb-mirror>

    <h1>[[team]]</h1>
    <iron-list items="[[posts]]" as="item" id="list" scroll-target="document">
      <template>
        <div>
          <div class="item" list-index$="[[index]]">
            <div class="horizontal">
              <img class="avatar" sizing="contain" src="[[item.image]]" title="[[item.email]]">
              <div class="vertical">
                <!-- <div class="name">[[item.email]]</div> -->
                <div class="giant">[[item.message]]</div>
                <span class="small">
                  <span>[[_getDate(item.createdAt)]]</span>
                  <span hidden$="[[!_hasLocation(item.location)]]">
                    <iron-icon icon="icons:location" class="location"></iron-icon>
                    [[item.location]]
                  </span>
                  <button hidden$="[[!_shouldEdit(item)]]" ref="[[item.$key]]" on-click="_delete">
                    <iron-icon icon="icons:delete" class="location"></iron-icon>
                    Delete post
                  </button>
                </span>
              </div>
            </div>
            <div class="heart-icon">
              <span>[[item.likes]]</span>
              <paper-icon-button icon="icons:favorite-border" on-click="_like" ref="[[item.$key]]"></paper-icon-button>
            </div>
          </div>
        </div>
      </template>
    </iron-list>
  </template>

  <script>
    var monthNames = [
      "January", "February", "March",
      "April", "May", "June", "July",
      "August", "September", "October",
      "November", "December"
    ];

    Polymer({
      is: 'view-posts',
      properties: {
        team: {
          type: String
        },

        ref: {
          type: String
        },

        uid: {
          type: String
        },

        posts: {
          type: Array,
          observer: '_postsChanged'
        },

        offline: {
          type: Boolean,
          value: false
        }
      },

      attached: function() {
        this.addEventListener('animationend', function(event) {
          var item = Polymer.dom(event).rootTarget;
          // Only the first item should animate over and over again, i.e.
          // every time we post to this list.
          if (item.getAttribute('list-index') == 0) {
            item.classList.remove('bounce');
          }
        });
      },

      _getDate: function(timestamp) {
        var date = new Date(timestamp);
        var seconds = Math.floor((new Date() - date) / 1000);

        if (seconds < 3600) {
          var minutes = Math.floor(seconds/60)
          return (minutes > 1) ? minutes + " minutes ago" : "1 minute ago";
        } else if (seconds < 86400) {
          var hours = Math.floor(seconds/3600)
          return (hours > 1) ? hours + " hours ago" : "1 hour ago";
        } else {
          var day = date.getDate();
          var monthIndex = date.getMonth();
          var year = date.getFullYear();
          return day + ' '  + monthNames[monthIndex] + ' ' + year;
        }
      },

      _postsChanged: function() {
        //this.$.list.fire('iron-resize');
      },

      _like: function(event) {
        var button = event.target;
        var ref = button.ref;

        if (button.icon === 'icons:favorite-border') {
          button.icon = 'icons:favorite';
          this.fire('post-like', {ref: ref, teamRef: this.ref});
        } else {
          button.icon = 'icons:favorite-border';
          this.fire('post-unlike', {ref: ref, teamRef: this.ref});
        }
      },

      _delete: function(event) {
        var button = event.target;
        var ref = button.ref;
        this.fire('post-delete', {ref: ref, teamRef: this.ref});
      },

      _hasLocation: function(location) {
        return !!location;
      },

      _shouldEdit: function(item) {
        return this.uid === item.uid;
      },

      _computeAnimated: function(item, index) {
        return index === 0 ? 'bounce' : '';
      }
    });
  </script>
</dom-module>
