<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<link rel="import" href="new-post.html">
<link rel="import" href="new-team.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="firebase-helper.html">
<link rel="import" href="view-posts.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;
        --app-background-color: #f5f5f5;
        --paper-tabs-selection-bar-color: var(--app-primary-color);
        --paper-tab-ink: var(--app-primary-color);

        display: block;
      }

      app-drawer-layout {
        background: var(--app-background-color);
      }

      app-drawer {
        color: #37474F;
        --app-drawer-content-container: {
          background: var(--app-background-color);
        };
        --app-drawer-width: 200px;
      }

      .main-content {
        padding: 20px;
        max-width: 540px;
        margin: auto;
      }

      app-header, .left-toolbar {
        color: #fff;
        background: #f5f5f5;
        color: #37474F;
        z-index: 10;
      }

      app-toolbar paper-button {
        font-size: 14px;
      }
/*
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }*/

      /*.drawer-list {
        margin: 0 20px;
      }*/

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: grey;
        font-weight: 100;
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }

      .drawer-list a paper-icon-button {
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .avatar {
        border-radius: 50%;
        width: 36px;
        height: 36px;
        vertical-align: middle;
        margin-left: 16px;
      }

      .spacer {
        @apply(--layout-flex);
        @apply(--layout-flex-auto);
      }

      .needsSignin {
        height: 100vh;
        text-align: center;
      }

      paper-button[raised] {
        background-color: var(--app-primary-color);
        color: white;
        font-size: 14px;
      }

      .teamSettings {
        display: inline-block;
      }
    </style>

    <firebase-app
      api-key="AIzaSyDqUICuPABxyDDgGvdZbgsO9r97qet6N_w"
      database-url="https://humblebrag-1cc8e.firebaseio.com"
      auth-domain="humblebrag-1cc8e.firebaseapp.com"
      storage-bucket="thumblebrag-1cc8e.appspot.com">
    </firebase-app>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer hidden$="[[!user]]">
        <app-toolbar class="left-toolbar">#humblebrag</app-toolbar>

        <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
          <template is="dom-repeat" items="[[teams]]">
            <a name="[[item.name]]" href="/[[item.name]]">
              <span>[[item.name]]</span>
              <paper-icon-button class="teamSettings" name="[[item.name]]" ref="[[item.ref]]" icon="icons:settings"
                  on-click="_showEditTeam">
              </paper-icon-button>
            </a>
          </template>
        </iron-selector>

        <paper-button raised on-click="_showCreateTeam"><iron-icon icon="icons:add"></iron-icon>Create team</paper-button>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout>
        <app-header fixed>
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div class="spacer"></div>

            <div hidden$="[[!user]]" class="userInfo">
              <img class="avatar" alt="github avatar" src="[[user.photoURL]]">
              <paper-button on-tap="logout">Sign out</paper-button>
            </div>
          </app-toolbar>
        </app-header>

        <div class="main-content">
          <new-post hidden team="[[page]]" id="newPost"></new-post>
          <new-team hidden id="newTeam"></new-team>

          <div class="needsSignin" hidden$="[[user]]">
            <h1>#humblebrag</h1>
            <paper-button on-tap="login" raised>Sign in with Google</paper-button>
          </div>

          <iron-pages
              selected="[[page]]"
              attr-for-selected="name"
              fallback-selection="404"
              role="main">
            <template is="dom-repeat" items="[[teams]]">
              <view-posts name="[[item.name]]" session="[[user]]" team="[[item.name]]" ref="[[item.ref]]"></view-posts>
            </template>
            <view-404 name="404"></view-404>
          </iron-pages>
        </div>
      </app-header-layout>

    </app-drawer-layout>
  </template>

  <script>
    Polymer({
      is: 'my-app',

      behaviors: [Polymer.FirebaseHelper],

      properties: {
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },

        teams: {
          type: Array,
          value: []
        },

        user: {
          type: Object,
          value: null,
          notify: true
        },

        location: {
          type: String,
          notify: true
        }
      },

      attached: function() {
        this._getLocation();

        var auth = firebase.auth();
        firebase.auth().onAuthStateChanged(function(user) {
          this.resetUI();
          this.user = user;
          this._firebaseUpdateUserInfo(user);
        }.bind(this));
      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      listeners: {
        'new-post': '_postNewMessage',
        'new-team': '_createTeam',
        'delete-team': '_deleteTeam',
        'rename-team': '_renameTeam',
        'delete-users': '_deleteUsers',
        'add-users': '_addUsers',
        'post-like': '_postLike',
        'post-unlike': '_postUnlike',
      },

      resetUI: function() {
        this.set('teams', []);
        this.$.newTeam.hidden = true;
      },

      login: function() {
        firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
      },

      logout: function() {
        firebase.auth().signOut();
      },

      /*******************************
       * Routes
       *******************************/
      _routePageChanged: function(page) {
        this.page = page;
      },

      // TODO: this is borked.
      _pageChanged: function(page) {
        // Load page import on demand. Show 404 page if fails
        // var resolvedPageUrl = this.resolveUrl(page==='404' ? 'view-404.html' : 'view-posts.html');
        // console.log(resolvedPageUrl)
        // this.importHref(resolvedPageUrl, null, this._showPage404, true);
      },

      _showPage404: function() {
        this.page = '404';
      },

      /*******************************
       * Posts
       *******************************/
      _postNewMessage: function(event) {
        var location = this.location || '';
        this._firebaseAddMessage(event.detail.team, event.detail.message, location);
      },

      /*******************************
       * Teams
       *******************************/
      _showCreateTeam: function() {
        this.$.newTeam.create();
      },

      _showEditTeam: function(event) {
        this.$.newTeam.edit(event.target.name, event.target.ref);
      },

      _createTeam: function(event) {
        this._firebaseAddTeam(event.detail.name, event.detail.users);
        this.$.newTeam.hidden = true;
      },

      _deleteTeam: function(event) {
        this._firebaseDeleteTeam(event.detail.ref, event.detail.name);
      },

      _renameTeam: function(event) {
        this._firebaseRenameTeam(event.detail.ref, event.detail.oldName, event.detail.newName);
      },

      _addUsers: function(event) {
        var teamId = event.detail.name;
        var newUsers = event.detail.users;

        // For each of the users in the list, add this team to them.
        firebase.database().ref('/users/').once('value', function(snapshot) {
          var users = snapshot.val();

          for (var user in users) {
            if (newUsers.indexOf(users[user].email) != -1 ) {
              var currentUserTeams = users[user].teams || [];
              currentUserTeams.push(teamId);
              firebase.database().ref('/users/' + user).update({teams: currentUserTeams});
            }
          }
        });
      },

      _deleteUsers: function(event) {
        var teamId = event.detail.name;
        var delUsers = event.detail.users;

        // For each of the users in the list, remove this team from them.
        firebase.database().ref('/users/').once('value', function(snapshot) {
          var users = snapshot.val();

          for (var user in users) {
            if (delUsers.indexOf(users[user].email) != -1 ) {
              var currentUserTeams = users[user].teams || [];
              var teamIndex = currentUserTeams.indexOf(teamId);
              currentUserTeams.splice(teamIndex, 1);
              firebase.database().ref('/users/' + user).update({teams: currentUserTeams});
            }
          }
        });
      },

      _postLike: function(event) {
        var postId = event.detail.uid;
        var postTeam = event.detail.team;

        firebase.database().ref('/posts/' + postTeam).child(postId).once('value', function(snapshot) {
          var likes = snapshot.val().likes || 0;
          snapshot.ref.update({likes: likes + 1});
        });
      },

      _postUnlike: function(event) {
        var postId = event.detail.uid;
        var postTeam = event.detail.team;

        firebase.database().ref('/posts/' + postTeam).child(postId).once('value', function(snapshot) {
          var likes = snapshot.val().likes || 0;
          if (likes !== 0) {
            snapshot.ref.update({likes: likes - 1});
          }
        });
      },

      _getLocation: function() {
        var self = this;
        navigator.geolocation.getCurrentPosition(function(position) {
          var request = new XMLHttpRequest();
          var method = 'GET';
          var url = 'http://maps.googleapis.com/maps/api/geocode/json?latlng='
              + position.coords.latitude + ','
              + position.coords.longitude;

          request.open('GET', url, true);
          request.onreadystatechange = function() {
            if (request.readyState == 4 && request.status == 200) {
              var data = JSON.parse(request.responseText);
              var addressComponents = data.results[0].address_components;

              var city, state;
              for(var i = 0; i < addressComponents.length; i++){
                if (addressComponents[i].types == 'locality,political') {
                  city = addressComponents[i].long_name;
                } else if (addressComponents[i].types == 'administrative_area_level_1,political') {
                  state = addressComponents[i].short_name;
                }
              }

              // TODO: this probably changes when you're on mobile and it should
              // be less bad and static.
              self.location = city + ', ' + state;
              console.log('We have a location!', self.location);
            }
          };
          request.send();
        });
      }
    });
  </script>
</dom-module>
