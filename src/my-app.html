<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        --app-primary-color: #FFC107;  /* orange */
        --app-secondary-color: #1976D2;  /* teal */
        --app-primary-text-color: #37474F;
        --app-secondary-text-color: #607D8B;
        --app-error-color: #F4511E;
        display: block;
      }

      [hidden] {
        display: none !important;
      }

      paper-button[raised] {
        background-color: var(--app-primary-color);
        color: white;
        font-size: 14px;
      }

      .offline {
        font-weight: 100;
        font-size: 18px;
      }

      .signin-view {
        color: white;
        position: absolute;
        top: 10%;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;  /* sit on top of the drawer */
        max-width: 400px;
        margin: auto;
        text-align: center;
      }

      h1 {
        letter-spacing: 2px;
        font-weight: 500;
      }

      p {
        font-weight: 100;
        font-size: 18px;
      }

      .giant {
        font-size: 100px;
      }

      .footer {
        font-size: 13px;
      }

      a:link, a:visited {
        color: var(--app-primary-color);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }
    </style>

    <firebase-app
      api-key="AIzaSyDqUICuPABxyDDgGvdZbgsO9r97qet6N_w"
      database-url="https://humblebrag-1cc8e.firebaseio.com"
      auth-domain="humblebrag-1cc8e.firebaseapp.com"
      storage-bucket="humblebrag-1cc8e.appspot.com">
    </firebase-app>
    <firebase-auth id="googleAuth" user="{{user}}" provider="google"></firebase-auth>

    <div class="signin-view" id="signin" hidden>
      <div class="giant">üëãüÜíüê±</div>
      <p>üì¢ &nbsp;stuff. Use ‚ú®üôäüòÇüî•.<br>
        (we only ask for your location to üìç your üìù)</p>
      <br>
      <button on-tap="login" raised hidden$="[[offline]]">Sign in with Google</button>
      <div hidden$="[[!offline]]" class="offline">You are currently offline, so you can't sign in to view posts.
        Come back and sign in when you're online!</div>
      <p class="footer">Made with üôà&nbsp; by <a href="https://twitter.com/notwaldorf">Monica</a>.
        Find this on <a href="https://github.com/notwaldorf/humblebrag">GitHub</a>.</p>
    </div>

    <humble-brag id="app" location="[[location]]" offline="[[offline]]"></humble-brag>
  </template>

  <script>
    Polymer({
      is: 'my-app',

      properties: {
        location: {
          type: String,
          notify: true
        },

        offline: {
          type: Boolean,
          value: false,
          notify: true
        },
      },

      // listeners: {
      //   'status-known-changed': '_statusChanged'
      // },
      //
      // _statusChanged: function(event) {
      //   var known = event.detail.value;
      // },

      ready: function() {
        this.offline = navigator.onLine === false;
        window.addEventListener('online', function() {
          this.offline = false;
        }.bind(this));
        window.addEventListener('offline', function() {
          this.offline = true;
        }.bind(this));
      },

      attached: function() {
        this._getLocation();
        firebase.auth().onAuthStateChanged(function(user) {
          if (!!user) {
            this.importHref(this.resolveUrl('humble-brag.html'), function() {
              this.$.signin.hidden = true;
              this.$.app.hidden = false;
              this.$.app.user = user;
              this.$.app.init();
            }, null, false);
          } else {
            this.$.signin.hidden = false;
            this.$.app.hidden = true;
          }
        }.bind(this));
      },

      login: function() {
        this.$.googleAuth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      },

      _getLocation: function() {
        var self = this;
        navigator.geolocation.getCurrentPosition(function(position) {
          var request = new XMLHttpRequest();
          var method = 'GET';
          var url = 'https://maps.googleapis.com/maps/api/geocode/json?latlng='
              + position.coords.latitude + ','
              + position.coords.longitude;

          request.open('GET', url, true);
          request.onreadystatechange = function() {
            if (request.readyState == 4 && request.status == 200) {
              var data = JSON.parse(request.responseText);
              var addressComponents = data.results[0].address_components;

              var city, state;
              for(var i = 0; i < addressComponents.length; i++){
                if (addressComponents[i].types == 'locality,political') {
                  city = addressComponents[i].long_name;
                } else if (addressComponents[i].types == 'administrative_area_level_1,political') {
                  state = addressComponents[i].short_name;
                }
              }

              // TODO: this probably changes when you're on mobile and it should
              // be less bad and static.
              self.location = city + ', ' + state;
              console.log('We have a location!', self.location);
            }
          };
          request.send();
        });
      }
    });
  </script>
</dom-module>
